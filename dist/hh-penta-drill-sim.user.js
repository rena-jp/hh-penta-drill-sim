// ==UserScript==
// @name         Hentai Heroes Penta Drill Sim
// @namespace    https://github.com/rena-jp/hh-penta-drill-sim
// @version      0.0.1
// @description  Add Penta Drill simulator for Hentai Heroes
// @author       rena
// @match        https://*.hentaiheroes.com/*
// @match        https://nutaku.haremheroes.com/*
// @match        https://*.gayharem.com/*
// @match        https://*.comixharem.com/*
// @match        https://*.pornstarharem.com/*
// @match        https://*.transpornstarharem.com/*
// @match        https://*.gaypornstarharem.com/*
// @match        https://*.mangarpg.com/*
// @grant        none
// @run-at       document-body
// @updateURL    https://github.com/rena-jp/hh-penta-drill-sim/raw/main/dist/hh-penta-drill-sim.meta.js
// @downloadURL  https://github.com/rena-jp/hh-penta-drill-sim/raw/main/dist/hh-penta-drill-sim.user.js
// ==/UserScript==

"use strict";(()=>{var v=`.pd-sim-result-box{position:relative;width:100%;height:0;.pd-sim-result{position:absolute;width:max-content;height:0;line-height:1.25rem;text-align:center;text-shadow:-1px -1px 0 #000,-1px 1px 0 #000,1px -1px 0 #000,1px 1px 0 #000;z-index:1;.pd-sim-label{font-size:.75rem}&.pd-sim-pending{color:#999}}}.penta-drill-battle .pd-sim-result-box .pd-sim-result{bottom:3rem;&.pd-sim-right{right:0}&.pd-sim-left{left:0}}.opponent-info-container .pd-sim-result-box .pd-sim-result{bottom:3.5rem;&.pd-sim-right{right:10%}&.pd-sim-left{left:10%}}.pd-sim-resource-box{width:100%;height:0;position:relative;#drill_energy{position:absolute;bottom:6rem;left:38%;right:38%}}
`;var H=`body.page-penta-drill-battle{.popup_wrapper #rewards_popup .flex-container .rewards .container .scrolling_area,.popup_wrapper #rewards_popup .flex-container .rewards .container .rewards_scrollable,.popup_wrapper #rewards_popup .flex-container .rewards .rewards_background{max-height:unset}.popup_wrapper #rewards_popup .flex-container .rewards .container .rewards_scrollable{zoom:.65}#rewards_big_header{zoom:.4}}
`;function G(e){let u=e.map(r=>I(r)),o=u.map(r=>r.id_girl),f=Object.fromEntries(u.map(r=>[r.id_girl,r]));return{ids:o,list:u,map:f,front:[2,3].map(r=>u[r]).filter(r=>r!=null),middle:[0,1,4].map(r=>u[r]).filter(r=>r!=null),back:[5,6].map(r=>u[r]).filter(r=>r!=null),reassurance_summary:[],pleasurelock_damage:0}}function M(e,u){let o=e.girls.map(r=>A(r,u)),f=o.map(r=>r.id_girl),g=Object.fromEntries(o.map(r=>[r.id_girl,r]));return{ids:f,list:o,map:g,front:[2,3].map(r=>o[r]).filter(r=>r!=null),middle:[0,1,4].map(r=>o[r]).filter(r=>r!=null),back:[5,6].map(r=>o[r]).filter(r=>r!=null),reassurance_summary:[],pleasurelock_damage:0}}function I(e){return{id_girl:e.id_girl,damage:e.damage,defense:e.defense,initial_defense:e.defense,initial_ego:e.initial_ego,chance:e.chance,remaining_ego:e.initial_ego,remaining_mana:e.remaining_mana,speed:e.speed,is_hero_fighter:e.is_hero_fighter,total_shields_amount:e.total_shields_amount,is_defeated:!1,trigger_skill:e.trigger_skill,id_role:e.girl.girl.id_role,burn_summary:[],stun_summary:0}}function A(e,u){let o=e.battle_caracs;return{id_girl:e.id_girl,damage:o.damage,defense:o.defense,initial_defense:o.defense,initial_ego:o.ego,chance:o.chance,remaining_ego:o.ego,remaining_mana:o.mana_starting,speed:o.speed,is_hero_fighter:u,total_shields_amount:0,is_defeated:!1,trigger_skill:D(e),id_role:e.girl.id_role,burn_summary:[],stun_summary:0}}function D(e){return[15,16,17,18,19,20,21,22].reduce((u,o)=>u??e.skills[o]?.skill,void 0)??{id_skill:23,level:0,skill_type:"light_punch",flat_value:null,percentage_value:50}}function R(e,u,o){let f=e.fighters,g=u.fighters,r=Math.min(f.length,g.length),h=Array(11).fill(0),a=0,p=0;for(let _=0;_<o;_++){let y=0,n=0,d=0;for(let i=0;i<r;i++){let t=G(f[i]),l=G(g[i]),s=F(t,l,n);y+=s.result,d+=s.rounds-n,n=s.rounds,s.result===1&&(n=0)}h[y]++,a+=y,p+=d}return{points:a/o,rounds:p/o,pointTable:h.map(_=>_/o)}}function S(e,u,o){let f=Math.min(e.length,u.length),g=Array(11).fill(0),r=0,h=0;for(let a=0;a<o;a++){let p=0,_=0,y=0;for(let n=0;n<f;n++){let d=M(e[n],!0),i=M(u[n],!1),t=F(d,i,_);p+=t.result,y+=t.rounds-_,_=t.rounds,t.result===1&&(_=0)}g[p]++,r+=p,h+=y}return{points:r/o,rounds:h/o,pointTable:g.map(a=>a/o)}}function F(e,u,o){let f=[...e.list.map((r,h)=>({attacker:r,attackerTeam:e,defenderTeam:u,teamOrder:h+7})),...u.list.map((r,h)=>({attacker:r,attackerTeam:u,defenderTeam:e,teamOrder:h}))].toSorted((r,h)=>{let a=r.attacker.speed,p=h.attacker.speed;return a<p?1:a>p||r.teamOrder<h.teamOrder?-1:1}),g=o-1;for(let r=0,h=f.length*100;r<h;r++){if(e.list.every(n=>n.is_defeated))return{result:0,rounds:g};if(u.list.every(n=>n.is_defeated))return{result:2,rounds:g};if(r%f.length===0){if(g++,g>=100)return{result:1,rounds:g};[e,u].forEach(n=>{n.reassurance_summary=n.reassurance_summary.reduce((d,i)=>(i.rounds_left--,i.rounds_left<=0?i.buffs.forEach(([t,l])=>{t.defense-=l}):d.push(i),d),[])})}let{attacker:a,attackerTeam:p,defenderTeam:_}=f[r%f.length];if(a.is_defeated)continue;let y=!1;if(a.stun_summary>0&&(a.stun_summary--,y=!0),!y){if(a.id_role===4&&p.list.some(n=>n!==a&&!n.is_defeated&&n.remaining_ego<n.initial_ego)){let n=p.list.filter(t=>t!==a&&!t.is_defeated&&t.remaining_ego<t.initial_ego),d=n.length===1?n[0]:n.reduce((t,l)=>t.remaining_ego<=l.remaining_ego?t:l),i=a.damage;T(a,d)&&(i+=Math.max(0,a.damage-d.defense)),a.is_hero_fighter||(i=Math.ceil(i*.05)),i=Math.min(i,d.initial_ego-d.remaining_ego),d.remaining_ego+=i}else{let n;if(a.id_role===5)n=O(_);else{let i=_.front.filter(t=>!t.is_defeated);i.length==0&&(i=_.middle.filter(t=>!t.is_defeated)),i.length==0&&(i=_.back.filter(t=>!t.is_defeated)),n=k(i)}let d=Math.max(0,a.damage-n.defense);T(a,n)&&(a.id_role===6?d=Math.ceil(d*2.4):d*=2),x(n,d)}if(a.remaining_mana<100){let n=a.id_role===2?35:20;a.remaining_mana=Math.min(100,a.remaining_mana+n)}if(a.is_hero_fighter){if(u.list.every(n=>n.is_defeated))return{result:2,rounds:g}}else if(e.list.every(n=>n.is_defeated))return{result:0,rounds:g};if(a.remaining_mana>=100)if(a.id_role===10){let d=p.list.filter(i=>i.is_defeated);if(d.length){let i=k(d),t=a.remaining_ego;a.is_hero_fighter||(t=Math.ceil(t*.05)),i.remaining_ego+=t,i.remaining_ego>0&&(i.is_defeated=!1),a.remaining_mana-=100}}else{let d=a.trigger_skill,i=d.percentage_value/100,t=d.flat_value;switch(d.id_skill){case 15:case 23:default:{let l=_.list.filter(c=>!c.is_defeated),s=k(l),m=Math.ceil(a.damage*i)-s.defense;m=Math.max(0,m),x(s,m),a.remaining_mana-=100;break}case 16:{p.list.filter(l=>!l.is_defeated).forEach(l=>{let s=Math.ceil(l.initial_ego*i);a.is_hero_fighter||(s=Math.ceil(s*.05)),l.remaining_ego=Math.min(l.initial_ego,l.remaining_ego+s)}),a.remaining_mana-=100;break}case 17:{let l=_.list.filter(m=>m.remaining_mana>0),s=Math.floor(i*l.reduce((m,c)=>{let b=Math.floor(c.remaining_mana*i);return c.remaining_mana-=b,m+c.remaining_mana+b},0));a.remaining_mana=Math.min(100,a.remaining_mana-100+s);break}case 18:{let l=p.list.filter(s=>s!=a&&!s.is_defeated&&s.total_shields_amount>=s.initial_ego);l=w(l,3),l.forEach(s=>{let m=Math.ceil(s.initial_ego*i);s.total_shields_amount=Math.min(s.initial_ego,s.total_shields_amount+m)}),a.remaining_mana-=100;break}case 19:{let l=_.list.filter(s=>!s.is_defeated);l=w(l,2),l.forEach(s=>{let m=Math.ceil(s.initial_ego*i);s.burn_summary.push({damage:m,rounds_left:t})}),a.remaining_mana-=100;break}case 20:{let l=p.list.filter(s=>s!=a&&!s.is_defeated);l=w(l,2),l.forEach(s=>{s.remaining_mana+=t}),a.remaining_mana-=100;break}case 21:{let s=p.list.filter(m=>!m.is_defeated).map(m=>{let c=Math.ceil(m.initial_defense*i);return m.defense+=c,[m,c]});p.reassurance_summary.push({buffs:s,rounds_left:t}),a.remaining_mana-=100;break}case 22:{let l=.1+d.level*.035;if(Math.random()<l){let s=_.list.filter(m=>!m.is_defeated);s=w(s,2),s.forEach(m=>{m.stun_summary+=2}),a.remaining_mana-=100}break}}}}if(a.burn_summary.length>0){let n=a.burn_summary[0];n.rounds_left--,x(a,n.damage),n.rounds_left<=0&&a.burn_summary.shift()}}return{result:1,rounds:g+1}}function T(e,u){return Math.random()<=.3*e.chance/(e.chance+u.chance)}function k(e){return e[Math.floor(e.length*Math.random())]}function w(e,u){if(e.length<=u)return e;let o=[];return[...Array(u)].forEach(()=>{let f=Math.floor(Math.random()*e.length);o.push(e[f]),e[f]=e[e.length-1],e.length--}),o}function O(e){return e.list.filter(u=>!u.is_defeated).reduce((u,o)=>u.remaining_ego<=o.remaining_ego?u:o)}function x(e,u){e.total_shields_amount>=u?e.total_shields_amount-=u:(e.remaining_ego-=u-e.total_shields_amount,e.total_shields_amount=0,e.remaining_ego<=0&&(e.is_defeated=!0))}(async function(){"use strict";if(!window.$)return;let e=h(),u=await e.importHHPlusPlus();if(!u)return;let{Helpers:o}=u,{hhPlusPlusConfig:f}=window;if(!o||!f)return;let g="pdsim";f.registerGroup({key:g,name:"PD Sim"}),[a,p,_,y].forEach(n=>{let d=n();!d||!d.run||f.registerModule({group:g,configSchema:{baseKey:n.name,label:d.label,default:d.default??!0,subSettings:d.settings},hasRun:!1,run(i){if(!this.hasRun){let t=d.run(i);this.hasRun=!0,Promise.resolve(t).then(l=>{this.hasRun=l!==!1})}},tearDown(){this.hasRun&&d.undo&&(this.hasRun=d.undo()===!1)}})}),f.loadConfig(),f.runModules();return;function h(){let n=new Promise(t=>{document.readyState==="loading"?window.addEventListener("DOMContentLoaded",()=>t(),{capture:!0,once:!0}):t()}),d=new Promise(t=>{n.then(()=>{$(()=>{t()})})});return Object.freeze({beforeGameInited(){return n},afterGameInited(){return d},run(t){return new Promise(l=>{queueMicrotask(()=>{Promise.resolve(t()).then(l)})})},domReady(){return d},async importHHPlusPlus(){return window.HHPlusPlus||(await this.beforeGameInited(),window.HHPlusPlus)||await this.afterGameInited(),window.HHPlusPlus},querySelector(t,l){return new Promise(s=>{let m=()=>{let b=t.querySelector(l),P=b!==null;return P&&s(b),P};if(m())return;let c=new MutationObserver(b=>{b.every(P=>P.addedNodes.length===0)||m()&&c.disconnect()});c.observe(t,{childList:!0,subtree:!0})})},querySelectorAll(t,l){return new Promise(s=>{let m=()=>{let b=t.querySelectorAll(l),P=b.length>0;return P&&s(b),P};if(m())return;let c=new MutationObserver(b=>{b.every(P=>P.addedNodes.length===0)||m()&&c.disconnect()});c.observe(t,{childList:!0,subtree:!0})})}})}function a(){return{label:"Penta Drill Sim",default:!0,settings:[{key:"arena",default:!0,label:"Run on table page"},{key:"preBattle",default:!0,label:"Run on pre-battle page"},{key:"heavy",default:!1,label:"Heavy simulation (slow)"}],async run(n){if(n.arena&&o.isCurrentPage("/penta-drill-arena.html")){await e.beforeGameInited(),$(document.head).append(`<style>${v}</style>`);let{player_datas:i,opponents_list:t}=window;if(i==null||t==null){console.log("Not found",{player_datas:i,opponents_list:t});return}let l=n.heavy?300:100;t.forEach(async s=>{let m=S(i.team,s.player.team,l);await e.afterGameInited();let c=d(m);$(`a[href$="id_opponent=${s.player.id_fighter}"]`).parent().after(c)})}if(o.isCurrentPage("/penta-drill-pre-battle")&&(await e.beforeGameInited(),$(document.head).append(`<style>${v}</style>`),n.preBattle)){let{hero_fighter:i,opponent_fighter:t}=window;if(i==null||t==null){console.log("Not found",{hero_fighter:i,opponent_fighter:t});return}let l=n.heavy?1e3:100,s=R(i,t,l);await e.afterGameInited();let m=d(s);$(".opponent_rewards").after(m)}function d(i){let t=$('<div class="pd-sim-result-box"></div>'),l=$('<div class="pd-sim-result pd-sim-left"></div>').html(`<div class="pd-sim-label">E[Points]:</div><span class="pd-sim-points">${i.points.toFixed(2)}</span>`).attr("tooltip",i.pointTable.map((m,c)=>[c,m]).filter(([m,c])=>c>0).map(([m,c])=>`${m} => ${(100*c).toFixed(0)}%`).join("<br />")),s=$('<div class="pd-sim-result pd-sim-right"></div>').html(`<div class="pd-sim-label">E[Rounds]:</div><span class="pd-sim-rounds">${i.rounds.toFixed(1)}</span>`);return t.append(l),t.append(s),t}}}}function p(){return{label:"Add Resouce Bar on pre-battle page",default:!0,async run(){o.isCurrentPage("/penta-drill-pre-battle")&&(await e.beforeGameInited(),$(".penta-drill-pre-battle-container").append('<div class="pd-sim-resource-box"><div class="energy_counter" type="drill" id="drill_energy"></div></div>'))}}}function _(){return{label:"Make the skip button appear faster",default:!0,async run(){o.isCurrentPage("/penta-drill-battle.html")&&(await e.beforeGameInited(),o.onAjaxResponse(/action=do_battles_penta_drill/i,()=>{$(".skip-buttons-container").attr("style","")}))}}}function y(){return{label:"Compact battle rewards",default:!0,async run(){o.isCurrentPage("/penta-drill-battle.html")&&(await e.beforeGameInited(),$(document.head).append(`<style>${H}</style>`))}}}})();})();
